@page "/Users/UserDetails/{UserId}"
@* @attribute [Authorize(Roles = "Admin")] *@

@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using PACOM.WebhookApp.Data

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavManager
@rendermode InteractiveServer


<MudPaper Class="pa-4" Elevation="2">

    <MudText Typo="Typo.h4" GutterBottom="true">User Details</MudText>

    @if (user == null)
    {
        <MudText>Loading...</MudText>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" sm="3">
                <MudText Color="Color.Primary" Typo="Typo.subtitle1">Email</MudText>
            </MudItem>
            <MudItem xs="12" sm="9">
                <MudText>@user.Email</MudText>
            </MudItem>

            <MudItem xs="12" sm="3" Class="mt-2">
                <MudText Color="Color.Primary" Typo="Typo.subtitle1">Username</MudText>
            </MudItem>
            <MudItem xs="12" sm="9" Class="mt-2">
                <MudText>@user.UserName</MudText>
            </MudItem>

            <MudItem xs="12" sm="3" Class="mt-2">
                <MudText Color="Color.Primary" Typo="Typo.subtitle1">Account Status</MudText>
            </MudItem>
            <MudItem xs="12" sm="9" Class="mt-2">
                <MudText>@status</MudText>
            </MudItem>

            <MudItem xs="12" sm="3" Class="mt-2">
                <MudText Color="Color.Primary" Typo="Typo.subtitle1">Email Confirmed</MudText>
            </MudItem>
            <MudItem xs="12" sm="9" Class="mt-2">
                <MudText>@user.EmailConfirmed</MudText>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <MudButton Color="Color.Error"
                   Variant="Variant.Filled"
                   OnClick="ToggleLockout">
            @(isDisabled ? "Enable Account" : "Disable Account")
        </MudButton>

        <MudButton Color="Color.Default"
                   Variant="Variant.Filled"
                   Class="ml-3"
                   Href="/Users/Users">
            Back
        </MudButton>
    }
</MudPaper>


@code {
    [Parameter] public string? UserId { get; set; }
    ApplicationUser? user;
    bool isDisabled;
    string status = "";

    protected override async Task OnInitializedAsync()
    {
        user = await UserManager.FindByIdAsync(UserId);
        isDisabled = user?.LockoutEnd.HasValue == true && user.LockoutEnd > DateTimeOffset.UtcNow;
        status = isDisabled ? "Disabled" : "Active";
    }

    async Task ToggleLockout()
    {
        if (!isDisabled)
            await UserManager.SetLockoutEndDateAsync(user, DateTimeOffset.UtcNow.AddYears(100));
        else
            await UserManager.SetLockoutEndDateAsync(user, null);

        NavManager.NavigateTo(NavManager.Uri, true);
    }

}