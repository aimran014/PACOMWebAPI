@page "/Users/UserRoles/{userId}"
@* @attribute [Authorize(Roles = "Admin")] *@

@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using PACOM.WebhookApp.Data
@using MudBlazor

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavManager
@inject ApplicationDbContext Db
@rendermode InteractiveServer

<MudPaper Class="pa-6 mx-auto" Style="max-width:650px;">
    <MudText Typo="Typo.h5" Class="mb-4">Manage User Access</MudText>

    @if (user == null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudTextField @bind-Value="user.Email" Label="Email" Variant="Variant.Outlined" Class="mb-3" />
        <MudTextField @bind-Value="user.UserName" Label="Username" Variant="Variant.Outlined" Class="mb-3" />

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.subtitle1">Role</MudText>
        <MudRadioGroup T="string" @bind-Value="selectedRole"
                       Orientation="Orientation.Vertical"
                       Class="mb-4">
            @foreach (var role in allRoles)
            {
                <MudRadio T="string" Value="@role.Name">@role.NormalizedName</MudRadio>
            }
        </MudRadioGroup>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.subtitle1">Tenant</MudText>
        <MudSelect T="int" @bind-Value="selectedOrganizations"
                   Label="Select Tenant"
                   Variant="Variant.Outlined"
                   Class="mb-4">
            @foreach (var org in allOrganizations)
            {
                <MudSelectItem T="int" Value="@org.Id">@org.Name</MudSelectItem>
            }
        </MudSelect>



        <MudDivider Class="my-4" />

        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveChanges" Class="me-2">
            Save Changes
        </MudButton>

        <MudButton Color="Color.Secondary" Variant="Variant.Outlined" OnClick="@(() => NavManager.NavigateTo("/Users/Users"))">
            Back
        </MudButton>
    }
</MudPaper>

@code {
    [Parameter] public string UserId { get; set; } = "";
    ApplicationUser? user;

    List<IdentityRole> allRoles = new();
    string? selectedRole = "";

    List<Organization> allOrganizations = new();
    int selectedOrganizations { get; set; }

    protected override async Task OnInitializedAsync()
    {
        user = await UserManager.FindByIdAsync(UserId);
        if (user == null) return;

        // Load Roles
        allRoles = RoleManager.Roles.ToList();
        var userRoles = await UserManager.GetRolesAsync(user);
        selectedRole = userRoles.FirstOrDefault();

        // Load all active organizations
        allOrganizations = Db.Organizations.ToList();
        var existingOrg = Db.OrganizationRoles.FirstOrDefault(x => x.UserId == UserId);
        selectedOrganizations = allOrganizations.FirstOrDefault(x => x.Id == existingOrg?.OrganizationId)?.Id ?? 0;
    }

    async Task SaveChanges()
    {
        if (user == null) return;

        // Update Role
        var currentRoles = await UserManager.GetRolesAsync(user);
        await UserManager.RemoveFromRolesAsync(user, currentRoles);

        if (!string.IsNullOrEmpty(selectedRole))
        {
            if (!await RoleManager.RoleExistsAsync(selectedRole))
                await RoleManager.CreateAsync(new IdentityRole(selectedRole));

            await UserManager.AddToRoleAsync(user, selectedRole);
        }

        // Update OrganizationRoles
        // Remove any existing organization
        var existingOrg = Db.OrganizationRoles.FirstOrDefault(x => x.UserId == UserId);
        if (existingOrg != null)
            Db.OrganizationRoles.Remove(existingOrg);

        // Add the new organization
        Db.OrganizationRoles.Add(new OrganizationRoles
        {
            UserId = UserId,
            OrganizationId = selectedOrganizations
        });

        await Db.SaveChangesAsync();
        await UserManager.UpdateAsync(user);

        NavManager.NavigateTo("/Users/Users");
    }
}