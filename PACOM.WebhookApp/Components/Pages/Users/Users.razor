@page "/Users/Users"

@* <!-- You can restrict roles later --> *@
@attribute [Authorize(Roles = "Admin")]  

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using PACOM.WebhookApp.Data
@using PACOM.WebhookApp.Service
@rendermode InteractiveServer

@inject NavigationManager NavManager
@inject DatasourcesService ds
@inject UserManager<ApplicationUser> UserManager


<PageTitle>Manage Users</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Registered Users</MudText>

<MudGrid>

    <MudItem xs="12" sm="2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick='() => NavManager.NavigateTo("/Register")'>
            New User
        </MudButton>
    </MudItem>


    <MudItem xs="12">

        @if (users == null)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else if (!users.Any())
        {
            <MudText>No registered users found.</MudText>
        }
        else
        {
            <MudTable Items="users" Hover="true" Dense="true" Bordered="true" Striped="true">
                <HeaderContent>
                    <MudTh>Email</MudTh>
                    <MudTh>Username</MudTh>
                    <MudTh>Email Confirmed</MudTh>
                    <MudTh>Account Actived</MudTh>
                    <MudTh>Action</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Email</MudTd>
                    <MudTd>@context.UserName</MudTd>
                    <MudTd>
                        @if (context.EmailConfirmed)
                        {
                            <MudIcon Color="Color.Success" Icon="@Icons.Material.Filled.Check" />
                        }
                        else
                        {
                            <MudIcon Color="Color.Error" Icon="@Icons.Material.Filled.Close" />
                        }
                    </MudTd>
                    <MudTd>
                        @(IsLocked(context) ? "Disabled" : "Active")
                    </MudTd>
                    <MudTd>
                        <MudButton Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small" Class="me-1" OnClick="@(() => ViewUser(context.Id))">
                            Details
                        </MudButton>

                        <MudButton Color="Color.Secondary" Variant="Variant.Filled" Size="Size.Small" Class="me-1" OnClick="@(() => EditRoles(context.Id))">
                            Roles
                        </MudButton>

                        <MudButton Color="@(IsLocked(context) ? Color.Success : Color.Warning)"
                                   Variant="Variant.Filled"
                                   Size="Size.Small"
                                   OnClick="@(() => ToggleLockout(context))">
                            @(IsLocked(context) ? "Enable" : "Disable")
                        </MudButton>

                    </MudTd>
                </RowTemplate>
            </MudTable>
        }

    </MudItem>


</MudGrid>

@code {
    private IList<ApplicationUser>? users;

    protected override async Task OnInitializedAsync()
    {
        users = await UserManager.Users.ToListAsync();
         LoadTenants();
    }

    bool IsLocked(ApplicationUser user)
    {
        // LockoutEnd > now means account is disabled
        return user.LockoutEnd.HasValue && user.LockoutEnd.Value > DateTimeOffset.UtcNow;
    }

    async Task ToggleLockout(ApplicationUser user)
    {
        if (IsLocked(user))
        {
            // Enable account
            await UserManager.SetLockoutEndDateAsync(user, null);
        }
        else
        {
            // Disable account (lockout far in the future)
            await UserManager.SetLockoutEndDateAsync(user, DateTimeOffset.UtcNow.AddYears(100));
        }

        // Refresh users list so the MudTable updates
        users = await UserManager.Users.ToListAsync();
        StateHasChanged();
    }

    private void LoadTenants()
    {
        List<string>? TenantName = DatasourcesService.ListPacomOrganization().Data;
    }

    void ViewUser(string id) => NavManager.NavigateTo($"/Users/UserDetails/{id}");
    void EditRoles(string id) => NavManager.NavigateTo($"/Users/UserRoles/{id}");
}