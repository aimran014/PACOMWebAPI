@page "/Users/Users"
@attribute [Authorize(Roles = "Admin")]

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using PACOM.WebhookApp.Data
@using PACOM.WebhookApp.Service
@rendermode InteractiveServer

@inject NavigationManager NavManager
@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar

<PageTitle>User Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo="Typo.h5">User Management</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Manage system access and account status</MudText>
        </div>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.PersonAdd"
                   OnClick='() => NavManager.NavigateTo("Account/RegisterAfterLogin")'>
            Create New User
        </MudButton>
    </div>

    <MudTable Items="@users"
              Dense="true"
              Hover="true"
              Bordered="false"
              Striped="true"
              Filter="new Func<ApplicationUser, bool>(FilterFunc)"
              Elevation="3"
              Loading="@(users == null)">

        <ToolBarContent>
            <MudText Typo="Typo.h6">System Users</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="searchString"
                          Placeholder="Search users..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0" />
        </ToolBarContent>

        <HeaderContent>
            <MudTh>User Identity</MudTh>
            <MudTh>Email Status</MudTh>
            <MudTh>Account Status</MudTh>
            <MudTh Style="text-align:right">Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            @* ... (Your Row content stays the same) ... *@
            <MudTd DataLabel="User">
                <div class="d-flex align-center">
                    <MudAvatar Color="@(IsLocked(context) ? Color.Error : Color.Primary)" Size="Size.Small" Class="mr-3">
                        @context.UserName?.FirstOrDefault().ToString().ToUpper()
                    </MudAvatar>
                    <div>
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.UserName</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Email</MudText>
                    </div>
                </div>
            </MudTd>

            <MudTd DataLabel="Email Confirmed">
                @if (context.EmailConfirmed)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.CheckCircle">Verified</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Warning" Size="Size.Small" Variant="Variant.Text" Icon="@Icons.Material.Filled.MarkEmailUnread">Pending</MudChip>
                }
            </MudTd>

            <MudTd DataLabel="Status">
                @if (IsLocked(context))
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.Lock">Disabled</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.Check">Active</MudChip>
                }
            </MudTd>

            <MudTd DataLabel="Actions" Style="text-align:right">
                <MudTooltip Text="View Details">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                   Color="Color.Default"
                                   Size="Size.Small"
                                   OnClick="@(() => ViewUser(context.Id))" />
                </MudTooltip>

                <MudTooltip Text="Manage Permissions">
                    <MudIconButton Icon="@Icons.Material.Filled.AdminPanelSettings"
                                   Color="Color.Secondary"
                                   Size="Size.Small"
                                   OnClick="@(() => EditRoles(context.Id))" />
                </MudTooltip>

                <MudTooltip Text="@(IsLocked(context) ? "Unlock Account" : "Disable Account")">
                    <MudIconButton Icon="@(IsLocked(context) ? Icons.Material.Filled.LockOpen : Icons.Material.Filled.Lock)"
                                   Color="@(IsLocked(context) ? Color.Success : Color.Error)"
                                   Size="Size.Small"
                                   OnClick="@(() => ToggleLockout(context))" />
                </MudTooltip>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    private IList<ApplicationUser>? users;
    private string searchString = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        users = await UserManager.Users.ToListAsync();
    }

    // Helper to check lock status
    bool IsLocked(ApplicationUser user)
    {
        return user.LockoutEnd.HasValue && user.LockoutEnd.Value > DateTimeOffset.UtcNow;
    }

    // Filter Logic for Search Bar
    private bool FilterFunc(ApplicationUser element)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.UserName?.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        if (element.Email?.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;
        return false;
    }

    async Task ToggleLockout(ApplicationUser user)
    {
        string message = "";
        Severity severity;

        if (IsLocked(user))
        {
            // Enable
            await UserManager.SetLockoutEndDateAsync(user, null);
            message = $"Account for {user.UserName} unlocked.";
            severity = Severity.Success;
        }
        else
        {
            // Disable
            await UserManager.SetLockoutEndDateAsync(user, DateTimeOffset.UtcNow.AddYears(100));
            message = $"Account for {user.UserName} disabled.";
            severity = Severity.Warning;
        }

        // Show feedback and refresh list
        Snackbar.Add(message, severity);
        await LoadUsers();
    }

    void ViewUser(string id) => NavManager.NavigateTo($"/Users/UserDetails/{id}");
    void EditRoles(string id) => NavManager.NavigateTo($"/Users/UserRoles/{id}");
}