@page "/Tenant/TenantEdit/{Id:int?}"

@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using PACOM.WebhookApp.Data
@using PACOM.WebhookApp.Service
@using System.Security.Claims

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject DatasourcesService OrgService
@rendermode InteractiveServer

<MudPaper Class="pa-4 mx-auto" Style="max-width:500px;">

        <MudTextField Label="Name" @bind-Value="organization.Name" Disabled="true" />
        <MudTextField Label="Code" @bind-Value="organization.Code" Disabled="true" />

        <MudTextField Label="Webhook Link" @bind-Value="organization.url" Required="true" />

    <MudSwitch T="bool" Label="Active" @bind-Value="organization.IsActive" Color="Color.Primary" />
        <MudText>Active</MudText>

        <MudButton OnClick="Save" Variant="Variant.Filled" Color="Color.Primary">Save</MudButton>

        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" @onclick='() => Nav.NavigateTo("/Tenant/Tenants")'>
            Cancel
        </MudButton>

</MudPaper>

@code {
    [Parameter] public int? Id { get; set; }
    Organization organization = new();

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
            organization = await Db.Organizations.FindAsync(Id.Value) ?? new();
    }

    async Task Save()
    {
        var response = await OrgService.ManageOrganizationAsync(organization);

        if(response.Error == 1)
        {
            Snackbar.Add(response.Message, Severity.Error);
            return;
        }

        // Get logged-in user safely (Blazor way)
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var userName = user.Identity?.Name ?? "System";

        // ✅ Correct audit log
        await OrgService.AuditTrailAsync(new AuditTrails
        {
            Action = "UPDATE_TENANT",
            UserName = userName,
            Timestamp = DateTime.UtcNow,
            Details = $"Updated tenant '{organization.Name}' (ID: {organization.Id})"
        });

        Snackbar.Add(response.Message, Severity.Success);
        Nav.NavigateTo("/Tenant/Tenants");

    }
}