@page "/Tenant/Tenants"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using PACOM.WebhookApp.Data
@using PACOM.WebhookApp.Service
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using System.Security.Claims

@inject ApplicationDbContext Db
@inject DatasourcesService DatasourceService
@inject NavigationManager NavManager
@inject IJSRuntime JsRuntime
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Tenant Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @* HEADER SECTION *@
    <div class="d-flex justify-space-between align-center mb-4">
        <div>
            <MudText Typo="Typo.h5">Tenant Management</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Overview of registered organizations and webhooks.</MudText>
        </div>

        @if (IsAdmin)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.AddBusiness"
                       OnClick="Create">
                New Organization
            </MudButton>
        }
    </div>

    @* DATA TABLE *@
    <MudTable Items="organizations"
              Dense="true"
              Hover="true"
              Striped="true"
              Bordered="false"
              Elevation="3"
              Filter="new Func<Organization, bool>(FilterFunc)"
              Loading="@isLoading">

        <ToolBarContent>
            <MudText Typo="Typo.h6">Organizations</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="searchString"
                          Placeholder="Search tenants..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0" />
        </ToolBarContent>

        <HeaderContent>
            <MudTh>Organization Identity</MudTh>
            <MudTh>Webhook Endpoint</MudTh>
            <MudTh>Status</MudTh>
            <MudTh Style="text-align:right">Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            @* Identity Column *@
            <MudTd DataLabel="Identity">
                <div class="d-flex align-center">
                    <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small" Class="mr-3">
                        @context.Name?.FirstOrDefault().ToString().ToUpper()
                    </MudAvatar>
                    <div>
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.Name</MudText>
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Default">@context.Code</MudChip>
                    </div>
                </div>
            </MudTd>

            @* URL Column *@
            <MudTd DataLabel="Webhook">
                <MudLink Href="@context.url" Target="_blank" Underline="Underline.None" Typo="Typo.body2">
                    @context.url
                </MudLink>
            </MudTd>

            @* Status Column *@
            <MudTd DataLabel="Status">
                @if (context.IsActive)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.DoNotDisturb">Inactive</MudChip>
                }
            </MudTd>

            @* Actions Column *@
            <MudTd DataLabel="Action" Style="text-align:right">
                <MudTooltip Text="Edit Configuration">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   OnClick="() => Edit(context.Id)" />
                </MudTooltip>

                @if (IsAdmin)
                {
                    <MudTooltip Text="Delete Tenant">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="() => Delete(context.Id)" />
                    </MudTooltip>
                }
            </MudTd>
        </RowTemplate>
    </MudTable>

</MudContainer>


@code {
    List<Organization> organizations = [];
    bool IsAdmin = false;
    bool isLoading = true;
    string searchString = "";

    // Authorization Context
    private ClaimsPrincipal? user;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true) return;

            IsAdmin = user.IsInRole("Admin");

            if (IsAdmin)
            {
                organizations = await Db.Organizations.ToListAsync();
            }
            else
            {
                // Non-admin logic
                var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);
                if (!string.IsNullOrEmpty(userId))
                {
                    var userRole = await Db.OrganizationRoles
                        .FirstOrDefaultAsync(or => or.UserId == userId);

                    if (userRole != null)
                    {
                        organizations = await Db.Organizations
                            .Where(o => o.Id == userRole.OrganizationId)
                            .ToListAsync();
                    }
                }
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    // Search Logic
    private bool FilterFunc(Organization element)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        if (element.Name?.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        if (element.Code?.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        return false;
    }

    private void Create() => NavManager.NavigateTo("/Tenant/TenantCreate");

    private void Edit(int id) => NavManager.NavigateTo($"/Tenant/TenantEdit/{id}");

    async Task Delete(int id)
    {
        if (!IsAdmin) return;

        // Optional: In a real app, you would add a Dialog Service confirmation here

        var org = await Db.Organizations.FindAsync(id);
        if (org is null) return;

        try
        {
            Db.Organizations.Remove(org);
            await Db.SaveChangesAsync();

            // Refresh list locally
            organizations.Remove(org);

            // Audit Log
            await DatasourceService.AuditTrailAsync(new AuditTrails
            {
                Action = "DELETE_TENANT",
                UserName = user?.Identity?.Name ?? "System",
                Timestamp = DateTime.UtcNow,
                Details = $"Deleted tenant '{org.Name}' (ID: {org.Id})"
            });

            Snackbar.Add($"Tenant '{org.Name}' deleted.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting tenant: {ex.Message}", Severity.Error);
        }
    }
}