@page "/Account/Events/Event"

@using Microsoft.AspNetCore.Authorization
@using PACOM.WebhookApp.Data
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@using System.Security.Claims
@using PACOM.WebhookApp.Service

@inject ApplicationDbContext Db
@inject NavigationManager NavManager
@inject IJSRuntime JsRuntime
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<MudPaper Class="pa-4">

    <MudText Typo="Typo.h5" Class="mb-4">Activity Events</MudText>

    <!-- ✅ FILTER BAR -->
    <MudStack Row="true" Spacing="2" Class="mb-4">
        <MudSelect T="string" Label="Organization" @bind-Value="_selectedOrg" Dense="true">
            <MudSelectItem Value="">All</MudSelectItem>
            @foreach (var org in _organizations)
            {
                <MudSelectItem Value="@org">@org</MudSelectItem>
            }
        </MudSelect>

        <MudSelect T="string" Label="Status" @bind-Value="_selectedStatus" Dense="true">
            <MudSelectItem Value="">All</MudSelectItem>
            <MudSelectItem Value="new">New</MudSelectItem>
            <MudSelectItem Value="success">Success</MudSelectItem>
            <MudSelectItem Value="failed">Failed</MudSelectItem>
        </MudSelect>

        <MudButton Variant="Variant.Filled" OnClick="LoadData">Refresh</MudButton>
    </MudStack>

    <!-- ✅ DATA TABLE -->
    <MudTable Items="_events" Hover="true" Dense="true" Striped="true">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Organization</MudTh>
            <MudTh>Event Time</MudTh>
            <MudTh>Status</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>@context.Id</MudTd>
            <MudTd>@context.Organization</MudTd>
            <MudTd>@context.EventTime.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>

            <MudTd>
                @if (context.IsProcessed == true)
                {
                    <MudChip Color="Color.Success" Size="Size.Small">Success</MudChip>
                }
                else if (context.IsProcessed == false)
                {
                    <MudChip Color="Color.Error" Size="Size.Small">Failed</MudChip>
                }
                else
                {
                    <MudChip Color="Color.Info" Size="Size.Small">New</MudChip>
                }
            </MudTd>
        </RowTemplate>
    </MudTable>

</MudPaper>

@code {

    private List<ActivityEvent> _events = new();
    private List<string> _organizations = new();

    private string _selectedOrg = "";
    private string _selectedStatus = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizations();
        await LoadData();
    }

    private async Task LoadOrganizations()
    {
        var orgs = await DatasourcesService.ListOrganizationAsync();
        _organizations = orgs
            .Where(x => x.IsActive)
            .Select(x => x.Name)
            .Distinct()
            .ToList();
    }

    private async Task LoadData()
    {
        var start = DateTime.UtcNow.AddDays(-1);
        var end = DateTime.UtcNow;

        var response = DatasourcesService.ListActivityEventAsync(start, end, _selectedOrg);
        var data = response.Data ?? new List<ActivityEvent>();

        // ✅ STATUS FILTER
        _events = _selectedStatus switch
        {
            "new" => data.Where(x => x.IsProcessed == null).ToList(),
            "success" => data.Where(x => x.IsProcessed == true).ToList(),
            "failed" => data.Where(x => x.IsProcessed == false).ToList(),
            _ => data
        };
    }
}