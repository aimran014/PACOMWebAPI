@page "/Account/Manage/ChangePassword"
@layout PACOM.WebhookApp.Components.Layout.AccountLayout

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using PACOM.WebhookApp.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ChangePassword> Logger
@inject NavigationManager NavigationManager

<PageTitle>Change Password</PageTitle>

<MudText Typo="Typo.h5" Class="mb-1">Change Password</MudText>
<MudText Typo="Typo.body2" Class="text-muted mb-6">Ensure your account is secure by using a strong password.</MudText>
<MudDivider Class="mb-8" />

@* --- STATUS MESSAGE --- *@
@if (!string.IsNullOrEmpty(statusMessage))
{
    <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="mb-6" ShowCloseIcon="true" CloseIconClicked="() => statusMessage = null">
        @statusMessage
    </MudAlert>
}
@if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-6" ShowCloseIcon="true" CloseIconClicked="() => errorMessage = null">
        @errorMessage
    </MudAlert>
}

<div style="max-width: 600px;">
    <EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync" method="post">
        <DataAnnotationsValidator />

        <MudGrid Spacing="3">
            @* OLD PASSWORD *@
            <MudItem xs="12">
                <MudTextField @bind-Value="Input.OldPassword"
                              Label="Current Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              For="@(() => Input.OldPassword)"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.LockOpen" />
            </MudItem>

            @* NEW PASSWORD *@
            <MudItem xs="12">
                <MudTextField @bind-Value="Input.NewPassword"
                              Label="New Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              For="@(() => Input.NewPassword)"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Key"
                              HelperText="Must be at least 6 characters long." />
            </MudItem>

            @* CONFIRM PASSWORD *@
            <MudItem xs="12">
                <MudTextField @bind-Value="Input.ConfirmPassword"
                              Label="Confirm New Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              For="@(() => Input.ConfirmPassword)"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock" />
            </MudItem>
        </MudGrid>

        <div class="d-flex justify-end mt-8">
            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Class="px-8">
                Update Password
            </MudButton>
        </div>
    </EditForm>
</div>

@code {
    private string? statusMessage;
    private string? errorMessage;
    private ApplicationUser user = default!;
    private bool hasPassword;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;
    [SupplyParameterFromForm] private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        hasPassword = await UserManager.HasPasswordAsync(user);

        if (!hasPassword)
        {
            RedirectManager.RedirectTo("Account/Manage/SetPassword");
        }

        // Check for success message in URL
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("statusMessage", out var msg))
        {
            statusMessage = msg;
        }
    }

    private async Task OnValidSubmitAsync()
    {
        var changePasswordResult = await UserManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);
        if (!changePasswordResult.Succeeded)
        {
            errorMessage = $"Error: {string.Join(", ", changePasswordResult.Errors.Select(error => error.Description))}";
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        Logger.LogInformation("User changed their password successfully.");

        // Reload page to show success message clearly
        RedirectManager.RedirectToCurrentPageWithStatus("Your password has been changed successfully.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [DataType(DataType.Password)]
        [Display(Name = "Current password")]
        public string OldPassword { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string NewPassword { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }
}