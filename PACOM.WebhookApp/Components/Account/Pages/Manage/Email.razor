@page "/Account/Manage/Email"
@layout PACOM.WebhookApp.Components.Layout.AccountLayout

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using PACOM.WebhookApp.Data

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager NavigationManager

<PageTitle>Email Settings</PageTitle>

<MudText Typo="Typo.h5" Class="mb-1">Email Settings</MudText>
<MudText Typo="Typo.body2" Class="text-muted mb-6">Manage your primary email address and verification status.</MudText>
<MudDivider Class="mb-8" />

@* --- STATUS MESSAGE (Feedback from Redirects) --- *@
@if (!string.IsNullOrEmpty(statusMessage))
{
    <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="mb-6" ShowCloseIcon="true" CloseIconClicked="() => statusMessage = null">
        @statusMessage
    </MudAlert>
}

@* --- 1. VERIFICATION WARNING (Only visible if email is NOT confirmed) --- *@
@if (!isEmailConfirmed)
{
    <MudAlert Severity="Severity.Warning" Class="mb-8" Icon="@Icons.Material.Filled.Warning" Variant="Variant.Outlined">
        <div class="d-flex flex-column flex-sm-row align-center justify-space-between gap-4" style="width:100%">
            <div>
                <MudText Typo="Typo.subtitle2" Color="Color.Warning"><b>Action Required</b></MudText>
                <MudText Typo="Typo.body2">Your email address <b>@email</b> is not yet verified.</MudText>
            </div>

            @* Separate Form for Verification Button *@
            <form @onsubmit="OnSendEmailVerificationAsync" @formname="send-verification" method="post">
                <AntiforgeryToken />
                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Warning"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.Send">
                    Resend Verification
                </MudButton>
            </form>
        </div>
    </MudAlert>
}

@* --- 2. CHANGE EMAIL FORM --- *@
<EditForm Model="Input" FormName="change-email" OnValidSubmit="OnValidSubmitAsync" method="post">
    <DataAnnotationsValidator />

    <MudGrid Spacing="3">

        @* CURRENT EMAIL (Read Only) *@
        <MudItem xs="12">
            @if (isEmailConfirmed)
            {
                <MudTextField Value="@email"
                              Label="Current Email"
                              Variant="Variant.Filled"
                              ReadOnly="true"
                              Disabled="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.CheckCircle"
                              AdornmentColor="Color.Success"
                              HelperText="Your email is verified." />
            }
            else
            {
                <MudTextField Value="@email"
                              Label="Current Email"
                              Variant="Variant.Filled"
                              ReadOnly="true"
                              Disabled="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Error"
                              AdornmentColor="Color.Warning"
                              HelperText="Pending verification." />
            }
        </MudItem>

        @* NEW EMAIL INPUT *@
        <MudItem xs="12">
            <MudTextField @bind-Value="Input.NewEmail"
                          Label="New Email Address"
                          Variant="Variant.Outlined"
                          InputType="InputType.Email"
                          For="@(() => Input.NewEmail)"
                          Placeholder="name@example.com"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.AlternateEmail" />
        </MudItem>
    </MudGrid>

    <div class="d-flex justify-end mt-8">
        <MudButton ButtonType="ButtonType.Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   Class="px-8">
            Change Email
        </MudButton>
    </div>
</EditForm>

@code {
    private string? statusMessage;
    private ApplicationUser user = default!;
    private string? email;
    private bool isEmailConfirmed;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm(FormName = "change-email")]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        email = await UserManager.GetEmailAsync(user);
        isEmailConfirmed = await UserManager.IsEmailConfirmedAsync(user);

        Input.NewEmail ??= email;

        // Check URL for status message (e.g. after redirect)
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("statusMessage", out var msg))
        {
            statusMessage = msg;
        }
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.NewEmail is null || Input.NewEmail == email)
        {
            statusMessage = "Your email is unchanged.";
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateChangeEmailTokenAsync(user, Input.NewEmail);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmailChange").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["email"] = Input.NewEmail, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, Input.NewEmail, HtmlEncoder.Default.Encode(callbackUrl));

        // Use NavigationManager to reload the page with a success message
        statusMessage = "Confirmation link sent. Please check your inbox.";
    }

    private async Task OnSendEmailVerificationAsync()
    {
        if (email is null) return;

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, email, HtmlEncoder.Default.Encode(callbackUrl));

        statusMessage = "Verification email sent. Please check your inbox.";
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "New email")]
        public string? NewEmail { get; set; }
    }
}