@page "/organizations"
@using PACOM.WebApp.Service
@using PACOM.WebApp.Data
@using PACOM.WebApp.Models
@using System.Collections.Generic
@inject DatasourcesService OrgService
@rendermode InteractiveServer

<h3>Organizations</h3>

<button class="btn btn-primary mb-3" @onclick="AddNew">Add New</button>


@if (organizations == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var org in organizations)
            {
                <tr>
                    <td>@org.Id</td>
                    <td>@org.Name</td>
                    <td>@org.Description</td>
                    <td>@org.url</td>
                    <td>@(org.IsActive ? "Yes" : "No")</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" @onclick="() => EditOrg(org)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteOrg(org.Id)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (showDialog)
{
    <div class="drawer @(showDialog ? "show" : "")">
        <div class="drawer-header">
            <h4>@(selectedOrg.Id == 0 ? "Add Organization" : "Edit Organization")</h4>
            <button class="btn btn-sm btn-secondary" @onclick="CloseDialog">X</button>
        </div>

        <EditForm Model="selectedOrg" OnValidSubmit="SaveOrg">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-2">
                <label>Name</label>
                <InputSelect class="form-control" @bind-Value="selectedOrg.Name">
                    <option value="">-- Select Name --</option>
                    @foreach (var name in organizationNames)
                    {
                        <option value="@name">@name</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-2">
                <label>Description</label>
                <InputText class="form-control" @bind-Value="selectedOrg.Description" />
            </div>

            <div class="mb-2">
                <label>Webhook Link</label>
                <InputText class="form-control" @bind-Value="selectedOrg.url" />
            </div>

            <div class="mb-2 form-check">
                <InputCheckbox class="form-check-input" @bind-Value="selectedOrg.IsActive" />
                <label class="form-check-label">Active</label>
            </div>

            <button type="submit" class="btn btn-success me-2">Save</button>
            <button type="button" class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
        </EditForm>
    </div>
}

@code {
    private List<PACOM.WebApp.Data.Organization>? organizations;
    private List<string> organizationNames = new();
    private PACOM.WebApp.Data.Organization selectedOrg = new();
    private bool showDialog = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizations();
    }

    private async Task LoadOrganizations()
    {
        var response = await OrgService.ListOrganizationAsync();
        organizations = response.Data ?? new List<PACOM.WebApp.Data.Organization>();

        // Proper async call to get PACOM dropdown list
        var pacomResponse = DatasourcesService.ListPacomOrganization().Data;
        organizationNames = pacomResponse.ToList();

        // Force UI to update
        StateHasChanged();
    }

    private void AddNew()
    {
        selectedOrg = new PACOM.WebApp.Data.Organization();
        showDialog = true;
    }

    private async Task EditOrg(PACOM.WebApp.Data.Organization org)
    {
        selectedOrg = new PACOM.WebApp.Data.Organization
        {
            Id = org.Id,
            Name = org.Name,
            Code = org.Name,
            Description = org.Description,
            url = org.url,
            IsActive = org.IsActive
        };

        var result = OrgService.ManageOrganizationAsync(selectedOrg);

        showDialog = true;
    }

    private async Task SaveOrg()
    {
        if (selectedOrg.Id != 0)
        {
            
        }

        selectedOrg.Code = selectedOrg.Name; // Ensure Code matches Name

        var result = await OrgService.ManageOrganizationAsync(selectedOrg);
        showDialog = false;

        await LoadOrganizations();
    }

    private async Task DeleteOrg(int id)
    {
        var result = await OrgService.RemoveOrganization(id);
        await LoadOrganizations(); // Refresh list
    }


    private void CloseDialog()
    {
        showDialog = false;
    }
}